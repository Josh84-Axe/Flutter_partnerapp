name: Deploy to Cloudflare Pages

on:
  push:
    branches: [ devin/1763121919-api-alignment-patch ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Flutter (matching project version)
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'
          channel: 'stable'

      # Install dependencies
      - name: Get Flutter packages
        run: flutter pub get

      # Build the web version (release)
      - name: Build Flutter web
        run: flutter build web --release

      # Install Wrangler (Cloudflare CLI)
      - name: Install Wrangler
        run: npm install -g @cloudflare/wrangler

      # Publish to Cloudflare Pages using Wrangler
      - name: Deploy to Cloudflare Pages
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PROJECT_NAME: ${{ secrets.CF_PROJECT_NAME }}
        run: |
          # Authenticate using the API token
          echo "${{ secrets.CF_API_TOKEN }}" > ~/.cf_token
          wrangler config --api-token $(cat ~/.cf_token)
          # Publish the built web folder to the specified project
          wrangler pages publish ./build/web --project-name $CF_PROJECT_NAME --account-id $CF_ACCOUNT_ID
