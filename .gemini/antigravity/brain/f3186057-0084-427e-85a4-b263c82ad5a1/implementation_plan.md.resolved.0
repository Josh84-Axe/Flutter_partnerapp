# Fix Plan Creation CRUD and Subscription Management

## Problem Analysis

After thorough investigation, I've identified the root causes of the issues:

### 1. Plan Creation CRUD Issues

**Root Cause**: The plan creation flow is correctly implemented and uses the proper API endpoints (`/partner/plans/create/`, `/partner/plans/{slug}/update/`, `/partner/plans/{slug}/delete/`). The CRUD operations are functional in the codebase.

**However**, there are potential issues with:
- **Field mapping**: The mobile app sends data with correct API field names (`data_limit`, `validity`, `shared_users`, `profile`, `profile_name`)
- **Data transformation**: Validity is correctly converted from days to minutes (multiply by 1440)
- **Repository integration**: [PlanRepository](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/plan_repository.dart#5-137) is properly connected to `AppState`

**Likely Issue**: The problem may be in how the configuration dropdowns are populated. The dropdowns for validity, data limit, and shared users rely on data from [PlanConfigRepository](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/plan_config_repository.dart#5-360) endpoints, which may not be returning data in the expected format.

### 2. Subscription Management Mock Data

**Root Cause**: The subscription management screen ([subscription_management_screen.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/screens/subscription_management_screen.dart)) is using hardcoded mock data instead of fetching from the API.

**Current State**:
- [PartnerRepository](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/partner_repository.dart#5-125) has [checkSubscriptionStatus()](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/partner_repository.dart#112-124) method that calls `/partner/subscription-plans/check/`
- `AppState` has [loadSubscription()](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/providers/app_state.dart#714-739) method that uses this endpoint
- **BUT** the subscription management screen displays hardcoded plans (Basic, Standard, Premium, Enterprise) instead of fetching from `/partner/subscription-plans/list/`
- No integration with `/partner/subscription-plans/purchase/` endpoint

## Proposed Changes

### Phase 1: Add Subscription Repository

Create a dedicated repository for subscription plan operations.

#### [NEW] [subscription_repository.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/subscription_repository.dart)

- Add `fetchSubscriptionPlans()` - GET `/partner/subscription-plans/list/`
- Add [checkSubscription()](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/partner_repository.dart#112-124) - GET `/partner/subscription-plans/check/`
- Add `purchaseSubscription(planId)` - POST `/partner/subscription-plans/purchase/`

---

### Phase 2: Update Subscription Model

#### [MODIFY] [subscription_model.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/models/subscription_model.dart)

- Add `SubscriptionPlanModel` class for available plans
- Update `SubscriptionModel.fromJson()` to handle API response structure
- Add proper field mapping for plan features

---

### Phase 3: Integrate Subscription API in AppState

#### [MODIFY] [app_state.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/providers/app_state.dart)

- Add `_subscriptionRepository` field
- Add `_availableSubscriptionPlans` list
- Add `loadAvailableSubscriptionPlans()` method
- Add `purchaseSubscriptionPlan(planId)` method
- Update [loadSubscription()](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/providers/app_state.dart#714-739) to use new repository
- Initialize subscription repository in `_initializeRepositories()`

---

### Phase 4: Update Subscription Management Screen

#### [MODIFY] [subscription_management_screen.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/screens/subscription_management_screen.dart)

- Remove hardcoded plan data (Basic, Standard, Premium, Enterprise)
- Load available plans from `appState.availableSubscriptionPlans`
- Display current subscription from `appState.subscription`
- Implement purchase functionality using `appState.purchaseSubscriptionPlan()`
- Add loading states and error handling
- Add localization for all strings

---

### Phase 5: Investigate Plan Configuration Issues

#### [MODIFY] [create_edit_internet_plan_screen.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/screens/create_edit_internet_plan_screen.dart)

- Add debug logging to identify why dropdowns may be empty
- Verify configuration data loading in [initState](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/screens/create_edit_internet_plan_screen.dart#25-42)
- Ensure proper error handling when configurations fail to load
- Add fallback UI when no configurations are available

#### [MODIFY] [app_state.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/providers/app_state.dart)

- Add debug logging in `loadAllConfigurations()`
- Verify data structure returned from [PlanConfigRepository](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/plan_config_repository.dart#5-360)
- Ensure proper parsing of nested response structures

---

### Phase 6: Add Comprehensive Error Handling

#### [MODIFY] [plan_repository.dart](file:///c:/Users/ELITEX21012G2/antigravity_partnerapp/Flutter_partnerapp/lib/repositories/plan_repository.dart)

- Add detailed error logging for create/update/delete operations
- Parse and return meaningful error messages from API responses
- Handle validation errors from backend

## Verification Plan

### Automated Tests

1. Test subscription plan fetching from API
2. Test current subscription status retrieval
3. Test plan creation with all required fields
4. Test plan update operations
5. Test plan deletion

### Manual Verification

1. **Subscription Management**:
   - Navigate to Subscription Management screen
   - Verify current subscription displays correctly
   - Verify available plans are loaded from API (not hardcoded)
   - Test subscription upgrade/purchase flow

2. **Plan Creation**:
   - Navigate to Create Plan screen
   - Verify all dropdowns populate with data from API
   - Create a new plan with all fields filled
   - Verify plan appears in plans list
   - Edit the created plan
   - Delete the created plan

3. **Configuration Screens**:
   - Verify validity periods load correctly
   - Verify data limits load correctly
   - Verify shared users load correctly
   - Verify hotspot profiles load correctly

## Expected API Response Structures

### `/partner/subscription-plans/list/`
```json
{
  "statusCode": 200,
  "data": [
    {
      "id": "plan-id",
      "name": "Basic",
      "price": 19.99,
      "features": {
        "maxRouters": 3,
        "maxUsers": 50,
        "support": "Email"
      }
    }
  ]
}
```

### `/partner/subscription-plans/check/`
```json
{
  "statusCode": 200,
  "data": {
    "plan": {
      "id": "plan-id",
      "name": "Standard",
      "price": 29.99
    },
    "active": true,
    "end_date": "2024-12-31"
  }
}
```

### `/partner/plans/create/`
```json
{
  "statusCode": 201,
  "data": {
    "id": "new-plan-id",
    "name": "My Plan",
    "price": 10.00,
    "data_limit": 10,
    "validity": 43200,
    "shared_users": 1,
    "profile": "profile-id",
    "profile_name": "Basic"
  }
}
```
